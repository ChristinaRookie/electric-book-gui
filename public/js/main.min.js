!function(){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var n=!1,r=function e(){return t(this,e),n||(n=new APIHttp),n},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/rpc/API/json",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";arguments.length>2&&void 0!==arguments[2]&&arguments[2];t(this,n),this._timeout=0,""==r&&(r=document.location.protocol+"//"+document.location.host),this.url=r+e,this.clearRPCErrorHandler()}return i(n,[{key:"setTimeout",value:function(e){this._timeout=e}},{key:"setRPCErrorHandler",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._errorHandler=t,0==this._errorHandler&&(this._errorHandler=function(t){console.error("RPC Error: ",e),alert("RPC ERROR: "+e)})}},{key:"clearRPCErrorHandler",value:function(){this._errorHandler=!1}},{key:"_reject",value:function(e,t){0!=this._errorHandler&&this._errorHandler(t),e(t)}},{key:"_rpc",value:function(e,t){var n=this;return t=Array.prototype.slice.call(t),new Promise(function(r,i){var o=null;if(window.XMLHttpRequest)o=new XMLHttpRequest;else{if(!window.ActiveXObject)return void n._reject(i,"No supported HttpRequest implementation");o=new ActiveXObject("Microsoft.XMLHTTP")}o.onreadystatechange=function(e,t,r){return function(){if(4==r.readyState){if(200==r.status){var i=r.response;return null==i?void n._reject(t,"Failed to parse response: "+r.response):null!=i.error?void n._reject(t,i.error):null!=i.result?void e(i.result):void e(null)}console.log("Request = ",r),n._reject(t,"Failed with "+r.statusText)}}}(r,i,o),o.timeout=n._timeout,o.open("POST",n.url+"?"+e,!0),o.responseType="json",o.send(JSON.stringify({id:n._id++,method:e,params:t}))})}},{key:"Version",value:function(){return this._rpc("Version",arguments)}},{key:"DeleteFile",value:function(e,t){return this._rpc("DeleteFile",arguments)}},{key:"ListFiles",value:function(e,t){return this._rpc("ListFiles",arguments)}},{key:"ListAllRepoFiles",value:function(e){return this._rpc("ListAllRepoFiles",arguments)}},{key:"GetFile",value:function(e,t){return this._rpc("GetFile",arguments)}},{key:"GetFileString",value:function(e,t){return this._rpc("GetFileString",arguments)}},{key:"UpdateFile",value:function(e,t,n){return this._rpc("UpdateFile",arguments)}},{key:"ListPullRequests",value:function(e){return this._rpc("ListPullRequests",arguments)}},{key:"PullRequestDiffList",value:function(e,t,n){return this._rpc("PullRequestDiffList",arguments)}},{key:"PullRequestVersions",value:function(e,t,n,r){return this._rpc("PullRequestVersions",arguments)}},{key:"PullRequestUpdate",value:function(e,t,n,r){return this._rpc("PullRequestUpdate",arguments)}},{key:"Commit",value:function(e,t){return this._rpc("Commit",arguments)}},{key:"PrintPdfEndpoint",value:function(e,t){return this._rpc("PrintPdfEndpoint",arguments)}},{key:"flatten",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(n){e.apply(t,n)}}}]),n}();window.API=r,"function"==typeof window.define&&window.define.amd&&window.define("API",[],function(){return window.API});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/rpc/API/json/ws",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t(this,e),""==r&&(r="ws"+("https:"==document.location.protocol?"s":"")+"://"+document.location.host),this._id=0,this.url=r+n,this.live={},this.queue=[],this.setRPCErrorHandler(null),this.startWs()}return i(e,[{key:"setRPCErrorHandler",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._errorHandler=e}},{key:"_reject",value:function(e,t){null!=this._errorHandler&&this._errorHandler(t),e(t)}},{key:"startWs",value:function(){var e=this;this.ws=new WebSocket(this.url),this.ws.onmessage=function(t){var n=JSON.parse(t.data);if(void 0==n||void 0==n.id)return void console.error("Failed to parse response: "+t.data);var r=e.live[n.id];return void 0==r?void console.error("Failed to find promise for "+t.data):(delete e.live[n.id],null!=n.error?void e._reject(r.reject,n.error):null!=n.result?void r.resolve(n.result):void r.resolve(null))},this.ws.onerror=function(e){console.error("ERROR on websocket:",e)},this.ws.onopen=function(t){console.log("Connected websocket");var n=!0,r=!1,i=void 0;try{for(var o,a=e.queue[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var l=o.value;e.ws.send(l)}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}console.log("Emptied queue of "+e.queue.length+" queued messages"),e.queue=[]},this.ws.onclose=function(t){console.log("Websocket closed - attempting reconnect in 1s"),setTimeout(function(){return e.startWs()},1e3)}}},{key:"_rpc",value:function(e,t){var n=this,r=this._id++;t=Array.prototype.slice.call(t);var i=JSON.stringify({id:r,method:e,params:t});return this.live[r]={resolve:null,reject:null},new Promise(function(e,t){n.live[r].resolve=e,n.live[r].reject=t,1==n.ws.readyState?n.ws.send(i):n.queue.push(i)})}},{key:"Version",value:function(){return this._rpc("Version",arguments)}},{key:"DeleteFile",value:function(e,t){return this._rpc("DeleteFile",arguments)}},{key:"ListFiles",value:function(e,t){return this._rpc("ListFiles",arguments)}},{key:"ListAllRepoFiles",value:function(e){return this._rpc("ListAllRepoFiles",arguments)}},{key:"GetFile",value:function(e,t){return this._rpc("GetFile",arguments)}},{key:"GetFileString",value:function(e,t){return this._rpc("GetFileString",arguments)}},{key:"UpdateFile",value:function(e,t,n){return this._rpc("UpdateFile",arguments)}},{key:"ListPullRequests",value:function(e){return this._rpc("ListPullRequests",arguments)}},{key:"PullRequestDiffList",value:function(e,t,n){return this._rpc("PullRequestDiffList",arguments)}},{key:"PullRequestVersions",value:function(e,t,n,r){return this._rpc("PullRequestVersions",arguments)}},{key:"PullRequestUpdate",value:function(e,t,n,r){return this._rpc("PullRequestUpdate",arguments)}},{key:"Commit",value:function(e,t){return this._rpc("Commit",arguments)}},{key:"PrintPdfEndpoint",value:function(e,t){return this._rpc("PrintPdfEndpoint",arguments)}},{key:"flatten",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(n){e.apply(t,n)}}}]),e}();window.APIWs=o,"function"==typeof window.define&&window.define.amd&&window.define("APIWs",[],function(){return window.APIWs});var a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=function(){function e(n){var r=this;t(this,e);var i=s("AddNewBookDialog"),o=a(i,2);this.el=o[0],this.$=o[1],Eventify(this.el,{choseType:function(){var e=this.$.newBookRadio.checked,t=this.$.collaborateRadio.checked;if(!e&&!t)return void alert("You need to choose one or the other");e?(this.$.newBook.style.display="block",this.$.repo_name.focus()):(this.$.collaborate.style.display="block",this.$.collaborate_repo.focus()),this.$.chooseType.style.display="none"}},this),jQuery(n).bind("open.zf.reveal",function(e){r.$.chooseType.style.display="block",r.$.newBookRadio.checked=!1,r.$.collaborateRadio.checked=!1,r.$.newBook.style.display="none",r.$.repo_name.value="",r.$.collaborate.style.display="none",r.$.collaborate_repo.value=""}),n.appendChild(this.el)}return i(e,[{key:"show",value:function(){}}]),e}();window.AddNewBookDialog=l;var a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=function e(n,r,i){if(t(this,e),null==n)return void console.log("NO parent for AllFilesEditor");this.dir=r,this.chooseFileCallback=i;var o=s("AllFilesEditor"),l=a(o,2);this.el=l[0],this.$=l[1];var u=!0,c=!1,f=void 0;try{for(var h,d=r.FileNamesOnly()[Symbol.iterator]();!(u=(h=d.next()).done);u=!0){var v=h.value;if("."!=v[0]){var y=document.createElement("option");y.setAttribute("value",v),y.textContent=v,this.$.select.appendChild(y)}}}catch(e){c=!0,f=e}finally{try{!u&&d.return&&d.return()}finally{if(c)throw f}}Eventify(this.el,{change:function(e){var t=this.$.select.value;console.log("selected "+t),this.chooseFileCallback(this,t)}},this),n.appendChild(this.el)},s=function(){var e={AddNewBookDialog:'<div>\n\t<div data-set="chooseType">\n\t\t<h1>Add a New Book</h1>\n\t\t<fieldset>\n\t\t\t<label>\n\t\t\t\t<input type="radio" value="new" data-set="newBookRadio" />\n\t\t\t\tStart an new book.\n\t\t\t</label>\n\t\t\t<label>\n\t\t\t\t<input type="radio" value="collaborate"\n\t\t\t\tdata-set="collaborateRadio" />\n\t\t\t\tCollaborate on an existing book.\n\t\t\t</label>\n\t\t</fieldset>\n\t\t<button data-event="click:choseType" class="button">Next</button>\n\t</div>\n\t<div data-set="newBook" style="display: none;">\n\t\t<h1>New Book</h1>\n\t\t<form method="post" action="/REPO/NEW">\n\t\t<input type="hidden" name="action" value="new" />\n\t\t<label>Enter the name for your new book.\n\t\t<input type="text" name="repo_name" placeholder="e.g. MobyDick" data-set="repo_name"/>\n\t\t</label>\n\t\t<input type="submit" class="button" value="New Book"/>\n\t\t</form>\n\t</div>\n\t<div data-set="collaborate">\n\t\t<h1>Collaborate</h1>\n\t\t<form method="post" action="/REPO/NEW">\n\t\t<input type="hidden" name="action" value="collaborate" />\n\t\t<label>Enter the owner and repo for the book you will collaborate on.\n\t\t<input type="text" name="collaborate_repo" placeholder="e.g. electricbooks/core" data-set="collaborate_repo" />\n\t\t</label>\n\t\t<input type="submit" class="button" value="Collaborate" />\n\t\t</form>\n\t</div>\n</div>\n',AllFilesEditor:'<div class="all-files-editor">\n\t<select data-set="select" data-event="change">\n\t</select>\n</div>',MergeEditor:'<div class="merge-editor">\n\t<div class="toolbar-menu">\n\t\t<button data-event="click:save"><i class="fa fa-save"> </i></button>\n\t</div>\n\t<div class="merge-mergely" data-set="mergely">\n\t</div>\n</div>',PullRequestDiffList:'<div>\n\t<h1>Differences</h1>\n\t<ul data-set="list">\n\t</ul>\n\t<button data-set="closePR"><i class="fa fa-check"> </i></button>\n</div>',PullRequestLink:'<div class="pull-request-link">\n\t<a href="#" data-set="link">_</a>\n</div>',RepoFileEditLink:'<ul>\n\t<li class="edit-link" data-set="this" data-event="click">\n\t\t<span class="file-dirty-tag"><i data-set="editing" class="fa fa-pencil"> </i></span>\n\t\t<a href="#"><span data-set="name"> </span></a>\n\t</li>\n</ul>\n',RepoFileEditor_ace:'<div class="repo-file-editor-workspace">\t\n\t<div class="toolbar-menu">\n\t\t<button data-event="click:save" data-set="save"><i class="fa fa-save"> </i></button>\n\t\t<button data-event="click:undo" data-set="undo"><i class="fa fa-undo"> </i></button>\n\t\t<div class="spacer"> </div>\n\t\t<button data-event="click:delete"><i class="fa fa-trash"> </i></button>\n\t</div>\n\t<div class="repo-file-editor repo-file-editor-ace" data-set="editor">\n\t</div>\n</div>',RepoFileEditor_codemirror:'<div class="repo-file-editor-workspace">\n\t<div class="repo-file-editor" data-set="editor">\n\t</div>\n</div>\n',RepoFileList:'<div class="repo-file-list">\n\t<div class="menu-header repo-files">\n\t\t<h2 class="menu-title">Files</h2>\n\t</div>\n\t<ul class="action-group" id="files" data-set="fileList">\n\t</ul>\n\t<button data-event=\'click:click-new\'>Add new file</button>\n</div>\n'};for(var t in e)e[t]=function e(t,n){var r=document.createElement("div");r.innerHTML=n;for(var i=r.firstElementChild;null!=i&&Node.ELEMENT_NODE!=i.nodeType;)i=i.nextSibling;if(null==i)return console.error("FAILED TO FIND ANY ELEMENT CHILD OF ",t,":",r),e("error","<em>No child elements in template "+t+"</em>");r=i;var o=r.querySelector('[data-set="this"]');return null!=o&&(r=o,r.removeAttribute("data-set")),r}(t,e[t]);return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e[t].cloneNode(!0);try{var i=!0,o=!1,a=void 0;try{for(var l,u=_(r,"[data-set]")[Symbol.iterator]();!(i=(l=u.next()).done);i=!0){var s=l.value,c=s.getAttribute("data-set");"$"==c.substr(0,1)&&(c=c.substr(1),s=jQuery(s)),n[c]=s}}catch(e){o=!0,a=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw a}}}catch(e){console.error("ERROR in DTemplate("+t+"): ",e)}return[r,n]}}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=null,f=function(){function e(){return t(this,e),null==c&&(c=this,this.api=new o),c}return i(e,null,[{key:"API",value:function(){return(new e).api}},{key:"Error",value:function(e){console.error("ERROR: ",e),alert(e)}},{key:"Toast",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){T.Show(e)})},{key:"Prompt",value:function(e){var t=prompt(e);return""==t&&(t=!1),Promise.resolve(""!=t&&t)}},{key:"flatten",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(n){e.apply(t,n)}}}]),e}();window.EBW=f,document.addEventListener("DOMContentLoaded",function(){jQuery(document).foundation()});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),h=function(){function e(n){t(this,e),this.cm=CodeMirror(n,{mode:"markdown",lineNumbers:!0,lineWrapping:!0})}return i(e,[{key:"getValue",value:function(){return this.cm.getDoc().getValue()}},{key:"setValue",value:function(e){this.cm.getDoc().setValue(e)}}],[{key:"Template",value:function(){return"RepoFileEditor_codemirror"}}]),e}(),a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();window.Eventify=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=!0,i=!1,o=void 0;try{for(var l,u=_(e,"[data-event]")[Symbol.iterator]();!(r=(l=u.next()).done);r=!0){var s=l.value,c=s.getAttribute("data-event"),f=!0,h=!1,d=void 0;try{for(var v,y=c.split(",")[Symbol.iterator]();!(f=(v=y.next()).done);f=!0){(function(){var r=v.value,i=r.split(":"),o=a(i,2),l=o[0],u=o[1];if(u||(u=l),void 0==t[u])return console.error("No method "+u+" (from "+r+") defined on ",t," while eventifying ",e),"continue";s.addEventListener(l,function(e){n?t[u].apply(n,[e]):t[u](e)})})()}}catch(e){h=!0,d=e}finally{try{!f&&y.return&&y.return()}finally{if(h)throw d}}}}catch(e){i=!0,o=e}finally{try{!r&&u.return&&u.return()}finally{if(i)throw o}}};var a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),d=function(){function e(n,r){var i=this;t(this,e),this.model=r;var o=s("MergeEditor"),l=a(o,2);this.el=l[0],this.$=l[1],Eventify(this.el,{save:function(e){e.preventDefault(),r.Update(this.get()).then().catch(function(e){return f.Error})}},this),"function"==typeof n?n(this.el):n.appendChild(this.el),r.GetContent().then(f.flatten(function(e,t){i.mergely(e,t)})).catch(function(e){f.Error(e)})}return i(e,[{key:"get",value:function(){return jQuery(this.mergely).mergely("cm","lhs").getDoc().getValue()}},{key:"mergely",value:function(e,t,n){this.$.mergely.textContent="",this.mergely=document.createElement("div"),this.$.mergely.appendChild(this.mergely);var r=jQuery(this.mergely).mergely({cmsettings:{readOnly:!1,lineNumbers:!0},editor_height:this.$.mergely.clientHeight,lhs:function(t){t(e)},rhs:function(e){e(t)}}),i=r.mergely("cm","right");console.log("right hand cm = ",i)}}]),e}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),v=function(){function e(n,r){t(this,e),this.diff=n,this.prArgs=r,this.DirtySignal=new signals.Signal,this.EditingSignal=new signals.Signal}return i(e,[{key:"GetContent",value:function(){return f.API().PullRequestVersions(this.prArgs.repo,this.prArgs.remoteURL,this.prArgs.remoteSHA,this.diff.path)}},{key:"Update",value:function(e){return f.API().PullRequestUpdate(this.prArgs.repo,this.prArgs.remoteSHA,this.diff.path,e)}},{key:"path",get:function(){return this.diff.path}},{key:"key",get:function(){return this.diff.remove_hash+":"+this.diff.local_hash}},{key:"origKey",get:function(){return this.key+"-original"}}]),e}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),y=function(){function e(n){var r=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"book";t(this,e),this.repo=n,""==i&&(i="book"),this.book=i,f.API().PrintPdfEndpoint(n,i).then(function(e){r.startListener(e[0])}).catch(f.Error)}return i(e,[{key:"startListener",value:function(e){var t=this,n=document.location.protocol+"//"+document.location.host+"/print/sse/"+e,r=new EventSource(n);r.addEventListener("open",function(){}),r.addEventListener("tick",function(e){}),r.addEventListener("info",function(e){var t=JSON.parse(e.data);T.Show("Printing: ",t)}),r.addEventListener("error",function(e){var t=JSON.parse(e.data);f.Error(t),r.close()}),r.addEventListener("output",function(e){var n=JSON.parse(e.data),r=document.location.protocol+"//"+document.location.host+"/www/"+t.repo+"/"+n;T.Show("Your PDF is ready: opening in a new window."),window.open(r,t.repo+"-output")}),r.addEventListener("done",function(e){r.close()}),r.onmessage=function(e){t.onmessage(e)},r.onerror=f.Error}},{key:"onmessage",value:function(e){console.log("PrintListener.onmessage: ",e)}}]),e}();window.PrintListener=y;var a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),p=function(){function e(n,r,i,o){var l=this;t(this,e),this.prArgs=i,this.mergelyParent=o;var u=s("PullRequestDiffList"),c=a(u,2);this.el=c[0],this.$=c[1],this.files=[],console.log("DIFFERENCE LIST = ",r);var f=!0,h=!1,d=void 0;try{for(var y,p=r[Symbol.iterator]();!(f=(y=p.next()).done);f=!0)!function(){var e=y.value,t=new v(e,i);console.log("DIFFERENCE: ",e),l.files.push(t),new b(l.el,t,function(e,n){l.viewDiff(t)})}()}catch(e){h=!0,d=e}finally{try{!f&&p.return&&p.return()}finally{if(h)throw d}}n.appendChild(this.el)}return i(e,[{key:"viewDiff",value:function(e){this.mergelyParent.textContent="",new d(this.mergelyParent,e)}}]),e}();window.PullRequestDiffList=p;var a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),m=function e(n,r,i){t(this,e),this.pr=i;var o=s("PullRequestLink"),l=a(o,2);this.el=l[0],this.$=l[1],this.$.link.textContent=this.pr.title,this.$.link.href=r+"/pull/"+this.pr.number,n.appendChild(this.el)},g=function e(n,r){t(this,e),null==n&&console.error("parent required for PullRequestList"),this.parent=n,this.api=f.API(),this.api.ListPullRequests(r).then(this.api.flatten(function(e){var t=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(t=(a=l.next()).done);t=!0){var u=a.value;new m(n,r,u)}}catch(e){i=!0,o=e}finally{try{!t&&l.return&&l.return()}finally{if(i)throw o}}})).catch(function(e){f.Error(e)})};window.PullRequestList=g;var w=function e(n){var r=this;t(this,e),T.Show("Hi there, message from me"),this.repo=n,this.editor=new k(document.getElementById("editor")),this.files=new E(document.getElementById("files"),n,this.editor),window.addEventListener("beforeunload",function(e){r.editor.setFile(null),r.files.IsDirty()&&(e.returnValue="confirm",e.stopPropagation())}),document.getElementById("repo-commit").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),f.Prompt("Enter the commit message:").then(function(e){e&&(f.Toast("Committing "+e),f.API().Commit(r.repo,e).then(function(){f.Toast("Changes committed: "+e)}).catch(f.Error))})}),document.getElementById("repo-print").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),f.Toast("Printing in progress..."),new y(r.repo,"book")})};window.RepoEditorPage=w;var a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),b=function(){function e(n,r,i){var o=this;t(this,e),this.parent=n,this.file=r;var l=s("RepoFileEditLink"),u=a(l,2);this.el=u[0],this.$=u[1],this.$.name.textContent=this.file.path.substring("book/text/".length),this.click=i,this.file.EditingSignal.add(function(e,t){o.SetEditing(t)}),this.SetEditing(!1),this.file.DirtySignal.add(function(e,t){t?o.el.classList.add("file-dirty"):o.el.classList.remove("file-dirty")}),Eventify(this.el,{click:function(e){e.preventDefault(),this.click(this,this.file)}},this),n&&n.appendChild(this.el)}return i(e,[{key:"SetEditing",value:function(e){this.$.editing.style.visibility=e?"visible":"hidden"}}]),e}(),a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=(function(){function e(n){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t(this,e),alert("@deprecated: use RepoFileEditorCM instead"),this.parent=n,this.repo=r,r||(this.repo=n.getAttribute("ebw-repo"));var i=s("RepoFileEditor_ace"),o=a(i,2);this.el=o[0],this.$=o[1],this.file=!1,Eventify(this.el,{save:function(e){e.preventDefault();this.editor.getValue();this.file.SetText(this.editor.getValue()),this.file.Save().then(function(){}).catch(function(e){f.Error(e)})},undo:function(e){if(e.preventDefault(),confirm("Undo the changes you've just made to "+this.file.path+"?")){var t=this.file.Original();this.file.SetText(t),this.setText(t),this.file.SetText(this.file.Original())}},delete:function(e){var t=this;e.preventDefault(),confirm("Are you sure you want to delete "+this.file.path+"?")&&this.file.Delete().then(function(e){t.file=null,t.setFile(null)}).catch(function(e){f.Error(e)})}},this),this.editor=ace.edit(this.$.editor),this.editor.setTheme("ace/theme/twilight"),this.editor.getSession().setMode("ace/mode/markdown"),this.parent.appendChild(this.el),sessionStorage.clear()}i(e,[{key:"setText",value:function(e){this.editor.setValue(new String(e))}},{key:"setFile",value:function(e){var t=this;if(this.file){if(this.file==e)return;this.file.SetText(this.editor.getValue()),this.file.SetEditing(!1)}if(!e)return void this.setText("Please select a file to edit.");e.GetText().then(function(n){t.file=e,t.file.SetEditing(!0);var r=!0,i=!1,o=void 0;try{for(var a,l=document.querySelectorAll("[ebw-current-filename]")[Symbol.iterator]();!(r=(a=l.next()).done);r=!0){a.value.textContent=e.path}}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}t.setText(n)}).catch(function(e){f.Error(e)})}}])}(),function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}()),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),k=function(){function e(n){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t(this,e),this.parent=n,this.repo=r,r||(this.repo=n.getAttribute("ebw-repo"));var i=s(h.Template()),o=a(i,2);this.el=o[0],this.$=o[1],this.file=!1,Eventify(document.getElementById("editor-actions"),{save:function(e){console.log("SAVE button pressed"),e.preventDefault(),this.file.SetText(this.editor.getValue()),this.file.Save().then(function(){console.log("Document saved")}).catch(function(e){f.Error(e)})},undo:function(e){if(e.preventDefault(),confirm("Undo the changes you've just made to "+this.file.path+"?")){var t=this.file.Original();this.file.SetText(t),this.setText(t),this.file.SetText(this.file.Original())}},delete:function(e){var t=this;e.preventDefault(),confirm("Are you sure you want to delete "+this.file.path+"?")&&this.file.Delete().then(function(e){t.file=null,t.setFile(null)}).catch(function(e){f.Error(e)})}},this),this.editor=new h(this.$.editor),this.parent.appendChild(this.el),sessionStorage.clear()}return i(e,[{key:"setText",value:function(e){this.editor.setValue(new String(e))}},{key:"setFile",value:function(e){var t=this;if(this.file){if(this.file==e)return;this.file.SetText(this.editor.getValue()),this.file.SetEditing(!1)}if(!e)return void this.setText("Please select a file to edit.");e.GetText().then(function(n){t.file=e,t.file.SetEditing(!0);var r=!0,i=!1,o=void 0;try{for(var a,l=document.querySelectorAll("[ebw-current-filename]")[Symbol.iterator]();!(r=(a=l.next()).done);r=!0){a.value.textContent=e.path}}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}t.setText(n)}).catch(function(e){f.Error(e)})}}]),e}(),a=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function e(e,t){
for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),E=function(){function e(n,r,i){var o=this;t(this,e),this.parent=n,this.repo=r,this.editor=i,this.files=[];var l=s("RepoFileList"),c=a(l,2);this.el=c[0],this.$=c[1],Eventify(this.el,{"click-new":function(e){var t=this;e.preventDefault();var n=prompt("Enter new filename:");if(n){var r=new P(this.repo,"book/text/"+n,{newFile:!0});this.files.push(r),new b(this.$.fileList,r,function(e,n){t.editor.setFile(n)}),this.editor.setFile(r)}}},this),this.api=f.API(),this.api.ListFiles(r,"^book/text/.*").then(this.api.flatten(function(e){var t=!0,n=!1,i=void 0;try{for(var a,l=e[Symbol.iterator]();!(t=(a=l.next()).done);t=!0){var u=a.value,s=new P(r,u);o.files.push(s),new b(o.$.fileList,s,function(e,t){o.editor.setFile(t)})}}catch(e){n=!0,i=e}finally{try{!t&&l.return&&l.return()}finally{if(n)throw i}}})).catch(function(e){f.Error(e)}),this.api.ListAllRepoFiles(r).then(this.api.flatten(function(e){var t=x.FromJS(!1,e);new u(document.getElementById("all-files-editor"),t,function(e,t){var n=new P(o.repo,t,{newFile:!1});o.editor.setFile(n)})})).catch(f.Error),this.parent.appendChild(this.el)}return i(e,[{key:"IsDirty",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,i=this.files[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){if(r.value.IsDirty())return!0}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}return!1}}]),e}();window.RepoFileList=E;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),S={},P=function(){function e(n,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};t(this,e);var o=n+":/"+r,a=S[o];return a||(this.repo=n,this.path=r,this.DirtySignal=new signals.Signal,this.EditingSignal=new signals.Signal,this.args=i,S[o]=this,this)}return i(e,[{key:"SetEditing",value:function(e){this.editing=e,this.EditingSignal.dispatch(this,e)}},{key:"IsEditing",value:function(){return this.editing}},{key:"IsDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return!!this.args.newFile||(e||(e=sessionStorage.getItem(this.storageKey)),sessionStorage.getItem(this.storageKey+"-original")!=e)}},{key:"Save",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return t||(t=sessionStorage.getItem(this.storageKey)),this.IsDirty(t)?new Promise(function(n,r){f.API().UpdateFile(e.repo,e.path,t).then(function(r){sessionStorage.setItem(e.storageKey+"-original",t),e.SetText(t),e.args.newFile=!1,n(!0)}).catch(function(e){f.Error(e),r(e)})}):Promise.resolve(!0)}},{key:"GetText",value:function(){var e=this,t=sessionStorage.getItem(this.storageKey);return t?Promise.resolve(t):this.args.newFile?Promise.resolve(""):new Promise(function(t,n){f.API().GetFileString(e.repo,e.path).then(function(n){var r=n[0];sessionStorage.setItem(e.storageKey+"-original",r),t(r)},function(e){n(e)})})}},{key:"SetText",value:function(e){sessionStorage.setItem(this.storageKey,e),this.DirtySignal.dispatch(this,this.IsDirty(e))}},{key:"Original",value:function(){return this.args.newFile?"":sessionStorage.getItem(this.storageKey+"-original")}},{key:"storageKey",get:function(){return this.repo+":"+this.path}}]),e}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),F=null,T=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return t(this,e),console.log("new Toast: el = ",n),null==F&&(F=this,n||(n=document.createElement("div"),document.body.appendChild(n)),F.parent=n,F.parent.classList.add("Toast")),F}return i(e,null,[{key:"Show",value:function(t){var n=new e,r=document.createElement("div");return r.innerHTML=t,n.parent.appendChild(r),setTimeout(function(){r.remove()},4500),r}}]),e}();window.Toast=T;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),R=function(){function e(n){t(this,e),this.iters=n,this.i=0}return i(e,[{key:"next",value:function(){if(this.i==this.iters.length)return{value:void 0,done:!0};var e=this.iters[this.i].next();return e.done?(this.i++,this.next()):e}},{key:Symbol.iterator,value:function(){return this}}]),e}(),A=function(){function e(n){t(this,e),this.qs=n,this.i=0}return i(e,[{key:"next",value:function(){return this.i==this.qs.length?{value:void 0,done:!0}:{value:this.qs.item(this.i++),done:!1}}},{key:Symbol.iterator,value:function(){return this}}]),e}(),_=function(e,t){var n=[];"function"==typeof e.matches?e.matches(t)&&n.push(e):"function"==typeof e.matchesSelector&&e.matchesSelector(t)&&n.push(e);var r=e.querySelectorAll(t),i=r[Symbol.iterator];return new R("function"==typeof i?[n[Symbol.iterator](),r[Symbol.iterator]()]:[n[Symbol.iterator](),new A(r)])},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),x=function(){function e(n,r){t(this,e),this._parent=n,this._name=r,this.Files=[]}return i(e,[{key:"Debug",value:function(){console.log(this.path);var e=!0,t=!1,n=void 0;try{for(var r,i=this.Files[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){r.value.Debug()}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}}},{key:"FileNamesOnly",value:regeneratorRuntime.mark(function e(){var t,n,r,i,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,n=!1,r=void 0,e.prev=3,i=this.Files[Symbol.iterator]();case 5:if(t=(o=i.next()).done){e.next=16;break}if(a=o.value,a.isFile){e.next=11;break}return e.delegateYield(a.FileNamesOnly(),"t0",9);case 9:e.next=13;break;case 11:return e.next=13,a.path;case 13:t=!0,e.next=5;break;case 16:e.next=22;break;case 18:e.prev=18,e.t1=e.catch(3),n=!0,r=e.t1;case 22:e.prev=22,e.prev=23,!t&&i.return&&i.return();case 25:if(e.prev=25,!n){e.next=28;break}throw r;case 28:return e.finish(25);case 29:return e.finish(22);case 30:case"end":return e.stop()}},e,this,[[3,18,22,30],[23,,25,29]])})},{key:"path",get:function(){return this._parent?this._parent.path+this.name+"/":""}},{key:"name",get:function(){return this._name}},{key:"isFile",get:function(){return!1}}],[{key:"FromJS",value:function(t,n){var r=new e(t,n.Name),i=!0,o=!1,a=void 0;try{for(var l,u=n.Files[Symbol.iterator]();!(i=(l=u.next()).done);i=!0){var s=l.value,c=null;s.Dir?(c=e.FromJS(r,s),r.Files.push(c)):(c=C.FromJS(r,s),r.Files.push(c))}}catch(e){o=!0,a=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw a}}return r}}]),e}(),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),C=function(){function e(n,r){t(this,e),this._parent=n,this._name=r}return i(e,[{key:"Debug",value:function(){console.log(this.path)}},{key:"path",get:function(){return(this._parent?this._parent.path:"")+this._name}},{key:"isFile",get:function(){return!0}},{key:"name",get:function(){return this._name}}],[{key:"FromJS",value:function(t,n){return new e(t,n.Name)}}]),e}()}();