!function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var n=!1,i=function e(){return t(this,e),n||(n=new APIHttp),n},r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),i=function(){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/rpc/API/json",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;t(this,n),this._timeout=0,""==i&&(i=document.location.protocol+"//"+document.location.host),this.url=i+e,this.clearRPCErrorHandler()}return r(n,[{key:"setTimeout",value:function(t){this._timeout=t}},{key:"setRPCErrorHandler",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._errorHandler=t,0==this._errorHandler&&(this._errorHandler=function(t){console.error("RPC Error: ",e),alert("RPC ERROR: "+e)})}},{key:"clearRPCErrorHandler",value:function(){this._errorHandler=!1}},{key:"_reject",value:function(t,e){0!=this._errorHandler&&this._errorHandler(e),t(e)}},{key:"_rpc",value:function(t,e){var n=this;return e=Array.prototype.slice.call(e),new Promise(function(i,r){var o=null;if(window.XMLHttpRequest)o=new XMLHttpRequest;else{if(!window.ActiveXObject)return void n._reject(r,"No supported HttpRequest implementation");o=new ActiveXObject("Microsoft.XMLHTTP")}var a=function(t,e,i){return function(){if(4==i.readyState){if(200==i.status){var r=i.response;return null==r?void n._reject(e,"Failed to parse response: "+i.response):null!=r.error?void n._reject(e,r.error):null!=r.result?void t(r.result):void t(null)}console.log("Request = ",i),n._reject(e,"Failed with "+i.statusText)}}};o.onreadystatechange=a(i,r,o),o.timeout=n._timeout,o.open("POST",n.url+"?"+t,!0),o.responseType="json",o.send(JSON.stringify({id:n._id++,method:t,params:e}))})}},{key:"Version",value:function(){return this._rpc("Version",arguments)}},{key:"DeleteFile",value:function(t,e){return this._rpc("DeleteFile",arguments)}},{key:"ListFiles",value:function(t,e){return this._rpc("ListFiles",arguments)}},{key:"GetFile",value:function(t,e){return this._rpc("GetFile",arguments)}},{key:"GetFileString",value:function(t,e){return this._rpc("GetFileString",arguments)}},{key:"UpdateFile",value:function(t,e,n){return this._rpc("UpdateFile",arguments)}},{key:"ListPullRequests",value:function(t){return this._rpc("ListPullRequests",arguments)}},{key:"PullRequestDiffList",value:function(t,e,n){return this._rpc("PullRequestDiffList",arguments)}},{key:"PullRequestVersions",value:function(t,e,n,i){return this._rpc("PullRequestVersions",arguments)}},{key:"PullRequestUpdate",value:function(t,e,n,i){return this._rpc("PullRequestUpdate",arguments)}},{key:"flatten",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(n){t.apply(e,n)}}}]),n}();window.API=i,"function"==typeof window.define&&window.define.amd&&window.define("API",[],function(){return window.API});var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/rpc/API/json/ws",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t(this,e),""==i&&(i="ws"+("https:"==document.location.protocol?"s":"")+"://"+document.location.host),this._id=0,this.url=i+n,this.live={},this.queue=[],this.setRPCErrorHandler(null),this.startWs()}return r(e,[{key:"setRPCErrorHandler",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._errorHandler=t}},{key:"_reject",value:function(t,e){null!=this._errorHandler&&this._errorHandler(e),t(e)}},{key:"startWs",value:function(){var t=this;this.ws=new WebSocket(this.url),this.ws.onmessage=function(e){var n=JSON.parse(e.data);if(void 0==n||void 0==n.id)return void console.error("Failed to parse response: "+e.data);var i=t.live[n.id];return void 0==i?void console.error("Failed to find promise for "+e.data):(delete t.live[n.id],null!=n.error?void t._reject(i.reject,n.error):null!=n.result?void i.resolve(n.result):void i.resolve(null))},this.ws.onerror=function(t){console.error("ERROR on websocket:",t)},this.ws.onopen=function(e){console.log("Connected websocket");var n=!0,i=!1,r=void 0;try{for(var o,a=t.queue[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var l=o.value;t.ws.send(l)}}catch(t){i=!0,r=t}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}console.log("Emptied queue of "+t.queue.length+" queued messages"),t.queue=[]},this.ws.onclose=function(e){console.log("Websocket closed - attempting reconnect in 1s"),setTimeout(function(){return t.startWs()},1e3)}}},{key:"_rpc",value:function(t,e){var n=this,i=this._id++;e=Array.prototype.slice.call(e);var r=JSON.stringify({id:i,method:t,params:e});return this.live[i]={resolve:null,reject:null},new Promise(function(t,e){n.live[i].resolve=t,n.live[i].reject=e,1==n.ws.readyState?n.ws.send(r):n.queue.push(r)})}},{key:"Version",value:function(){return this._rpc("Version",arguments)}},{key:"DeleteFile",value:function(t,e){return this._rpc("DeleteFile",arguments)}},{key:"ListFiles",value:function(t,e){return this._rpc("ListFiles",arguments)}},{key:"GetFile",value:function(t,e){return this._rpc("GetFile",arguments)}},{key:"GetFileString",value:function(t,e){return this._rpc("GetFileString",arguments)}},{key:"UpdateFile",value:function(t,e,n){return this._rpc("UpdateFile",arguments)}},{key:"ListPullRequests",value:function(t){return this._rpc("ListPullRequests",arguments)}},{key:"PullRequestDiffList",value:function(t,e,n){return this._rpc("PullRequestDiffList",arguments)}},{key:"PullRequestVersions",value:function(t,e,n,i){return this._rpc("PullRequestVersions",arguments)}},{key:"PullRequestUpdate",value:function(t,e,n,i){return this._rpc("PullRequestUpdate",arguments)}},{key:"flatten",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(n){t.apply(e,n)}}}]),e}();window.APIWs=o,"function"==typeof window.define&&window.define.amd&&window.define("APIWs",[],function(){return window.APIWs});var a=function(){var t={MergeEditor:'<div class="merge-editor">\n\t<div class="toolbar-menu">\n\t\t<button data-event="click:save"><i class="fa fa-save"> </i></button>\n\t</div>\n\t<div class="merge-mergely" data-set="mergely">\n\t</div>\n</div>',PullRequestDiffList:'<div>\n\t<h1>Differences</h1>\n\t<ul data-set="list">\n\t</ul>\n\t<button data-set="closePR"><i class="fa fa-check"> </i></button>\n</div>',PullRequestLink:'<div class="pull-request-link">\n\t<a href="#" data-set="link">_</a>\n</div>',RepoFileEditLink:'<ul>\n\t<li class="edit-link" data-set="this" data-event="click">\n\t\t<span class="file-dirty-tag"><i data-set="editing" class="fa fa-pencil"> </i></span>\n\t\t<span data-set="name"> </span>\n\t</li>\n</ul>',RepoFileEditor_ace:'<div class="repo-file-editor-workspace">\t\n\t<div class="toolbar-menu">\n\t\t<button data-event="click:save" data-set="save"><i class="fa fa-save"> </i></button>\n\t\t<button data-event="click:undo" data-set="undo"><i class="fa fa-undo"> </i></button>\n\t\t<div class="spacer"> </div>\n\t\t<button data-event="click:delete"><i class="fa fa-trash"> </i></button>\n\t</div>\n\t<div class="repo-file-editor repo-file-editor-ace" data-set="editor">\n\t</div>\n</div>',RepoFileEditor_codemirror:'<div class="repo-file-editor-workspace">\t\n\t<div class="toolbar-menu">\n\t\t<button data-event="click:save" data-set="save"><i class="fa fa-save"> </i></button>\n\t\t<button data-event="click:undo" data-set="undo"><i class="fa fa-undo"> </i></button>\n\t\t<div class="spacer"> </div>\n\t\t<button data-event="click:delete"><i class="fa fa-trash"> </i></button>\n\t</div>\n\t<div class="repo-file-editor repo-file-editor-ace" data-set="editor">\n\t</div>\n</div>',RepoFileList:'<div class="repo-file-list">\n\t<div class="menu-header">\n\t\t<h1 class="menu-title">Chapters</h1>\n\t\t<div class="menu-controls">\n\t\t\t<button data-event=\'click:click-new\'><i class="fa fa-plus"> </i></button>\n\t\t</div>\n\t</div>\n\t<ul id="files" data-set="fileList">\n\t</ul>\n</div>'},e=function t(e,n){var i=document.createElement("div");i.innerHTML=n;for(var r=i.firstElementChild;null!=r&&Node.ELEMENT_NODE!=r.nodeType;)r=r.nextSibling;if(null==r)return console.error("FAILED TO FIND ANY ELEMENT CHILD OF ",e,":",i),t("error","<em>No child elements in template "+e+"</em>");i=r;var o=i.querySelector('[data-set="this"]');return null!=o&&(i=o,i.removeAttribute("data-set")),i};for(var n in t)t[n]=e(n,t[n]);return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t[e].cloneNode(!0);try{var r=!0,o=!1,a=void 0;try{for(var l,u=S(i,"[data-set]")[Symbol.iterator]();!(r=(l=u.next()).done);r=!0){var s=l.value,c=s.getAttribute("data-set");"$"==c.substr(0,1)&&(c=c.substr(1),s=jQuery(s)),n[c]=s}}catch(t){o=!0,a=t}finally{try{!r&&u.return&&u.return()}finally{if(o)throw a}}}catch(t){console.error("ERROR in DTemplate("+e+"): ",t)}return[i,n]}}(),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),l=null,u=function(){function e(){return t(this,e),null==l&&(l=this,this.api=new o),l}return r(e,null,[{key:"API",value:function(){var t=new e;return t.api}},{key:"Error",value:function(t){console.error("ERROR: ",t),alert(t)}},{key:"flatten",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(n){t.apply(e,n)}}}]),e}();window.EBW=u;var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),s=function(){function e(n){t(this,e),this.cm=CodeMirror(n,{mode:"markdown",lineNumbers:!0,lineWrapping:!0})}return r(e,[{key:"getValue",value:function(){return this.cm.getDoc().getValue()}},{key:"setValue",value:function(t){this.cm.getDoc().setValue(t)}}],[{key:"Template",value:function(){return"RepoFileEditor_codemirror"}}]),e}(),c=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();window.Eventify=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=!0,r=!1,o=void 0;try{for(var a,l=S(t,"[data-event]")[Symbol.iterator]();!(i=(a=l.next()).done);i=!0){var u=a.value,s=u.getAttribute("data-event"),f=!0,h=!1,d=void 0;try{for(var v,y=function(){var i=v.value,r=i.split(":"),o=c(r,2),a=o[0],l=o[1];return l||(l=a),void 0==e[l]?(console.error("No method "+l+" (from "+i+") defined on ",e," while eventifying ",t),"continue"):void u.addEventListener(a,function(t){e[l].apply(n,[t])})},p=s.split(",")[Symbol.iterator]();!(f=(v=p.next()).done);f=!0){y()}}catch(t){h=!0,d=t}finally{try{!f&&p.return&&p.return()}finally{if(h)throw d}}}}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}};var c=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),f=function(){function e(n,i){var r=this;t(this,e),this.model=i;var o=a("MergeEditor"),l=c(o,2);this.el=l[0],this.$=l[1],Eventify(this.el,{save:function(t){t.preventDefault(),i.Update(this.get()).then().catch(function(t){return u.Error})}},this),"function"==typeof n?n(this.el):n.appendChild(this.el),i.GetContent().then(u.flatten(function(t,e){r.mergely(t,e)})).catch(function(t){u.Error(t)})}return r(e,[{key:"get",value:function(){var t=jQuery(this.mergely).mergely("cm","lhs");return t.getDoc().getValue()}},{key:"mergely",value:function(t,e,n){this.$.mergely.textContent="",this.mergely=document.createElement("div"),this.$.mergely.appendChild(this.mergely);var i=jQuery(this.mergely).mergely({cmsettings:{readOnly:!1,lineNumbers:!0},editor_height:this.$.mergely.clientHeight,lhs:function(e){e(t)},rhs:function(t){t(e)}}),r=i.mergely("cm","right");console.log("right hand cm = ",r)}}]),e}(),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),h=function(){function e(n,i){t(this,e),this.diff=n,this.prArgs=i,this.DirtySignal=new signals.Signal,this.EditingSignal=new signals.Signal}return r(e,[{key:"GetContent",value:function(){return u.API().PullRequestVersions(this.prArgs.repo,this.prArgs.remoteURL,this.prArgs.remoteSHA,this.diff.path)}},{key:"Update",value:function(t){return u.API().PullRequestUpdate(this.prArgs.repo,this.prArgs.remoteSHA,this.diff.path,t)}},{key:"path",get:function(){return this.diff.path}},{key:"key",get:function(){return this.diff.remove_hash+":"+this.diff.local_hash}},{key:"origKey",get:function(){return this.key+"-original"}}]),e}(),c=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),d=function(){function e(n,i,r,o){var l=this;t(this,e),this.prArgs=r,this.mergelyParent=o;var u=a("PullRequestDiffList"),s=c(u,2);this.el=s[0],this.$=s[1],this.files=[],console.log("DIFFERENCE LIST = ",i);var f=!0,d=!1,v=void 0;try{for(var y,p=function(){var t=y.value,e=new h(t,r);console.log("DIFFERENCE: ",t),l.files.push(e),new g(l.el,e,function(t,n){l.viewDiff(e)})},m=i[Symbol.iterator]();!(f=(y=m.next()).done);f=!0)p()}catch(t){d=!0,v=t}finally{try{!f&&m.return&&m.return()}finally{if(d)throw v}}n.appendChild(this.el)}return r(e,[{key:"viewDiff",value:function(t){this.mergelyParent.textContent="",new f(this.mergelyParent,t)}}]),e}();window.PullRequestDiffList=d;var c=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),v=function e(n,i,r){t(this,e),this.pr=r;var o=a("PullRequestLink"),l=c(o,2);this.el=l[0],this.$=l[1],this.$.link.textContent=this.pr.title,this.$.link.href=i+"/pull/"+this.pr.number,n.appendChild(this.el)},y=function e(n,i){t(this,e),this.parent=n,this.api=u.API(),this.api.ListPullRequests(i).then(this.api.flatten(function(t){var e=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(e=(a=l.next()).done);e=!0){var u=a.value;new v(n,i,u)}}catch(t){r=!0,o=t}finally{try{!e&&l.return&&l.return()}finally{if(r)throw o}}})).catch(function(t){u.Error(t)})};window.PullRequestList=y;var p=function e(n){var i=this;t(this,e),this.editor=new m(document.getElementById("editor")),this.files=new w(document.getElementById("files"),n,this.editor),new y(document.getElementById("pull-request-list"),n),window.addEventListener("beforeunload",function(t){i.editor.setFile(null),i.files.IsDirty()&&(t.returnValue="confirm",t.stopPropagation())})};window.RepoEditorPage=p;var c=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),g=function(){function e(n,i,r){var o=this;t(this,e),this.parent=n,this.file=i;var l=a("RepoFileEditLink"),u=c(l,2);this.el=u[0],this.$=u[1],this.$.name.textContent=this.file.path.substring("book/text/".length),this.click=r,this.file.EditingSignal.add(function(t,e){o.SetEditing(e)}),this.SetEditing(!1),this.file.DirtySignal.add(function(t,e){e?o.el.classList.add("file-dirty"):o.el.classList.remove("file-dirty")}),Eventify(this.el,{click:function(t){t.preventDefault(),o.click(o,o.file)}},this),n&&n.appendChild(this.el)}return r(e,[{key:"SetEditing",value:function(t){this.$.editing.style.visibility=t?"visible":"hidden"}}]),e}(),c=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),c=(function(){function e(n){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t(this,e),this.parent=n,this.repo=i,i||(this.repo=n.getAttribute("ebw-repo"));var r=a("RepoFileEditor_ace"),o=c(r,2);this.el=o[0],this.$=o[1],this.file=!1,Eventify(this.el,{save:function(t){t.preventDefault();this.editor.getValue();this.file.SetText(this.editor.getValue()),this.file.Save().then(function(){}).catch(function(t){u.Error(t)})},undo:function(t){if(t.preventDefault(),confirm("Undo the changes you've just made to "+this.file.path+"?")){var e=this.file.Original();this.file.SetText(e),this.setText(e),this.file.SetText(this.file.Original())}},delete:function(t){var e=this;t.preventDefault(),confirm("Are you sure you want to delete "+this.file.path+"?")&&this.file.Delete().then(function(t){e.file=null,e.setFile(null)}).catch(function(t){u.Error(t)})}},this),this.editor=ace.edit(this.$.editor),this.editor.setTheme("ace/theme/twilight"),this.editor.getSession().setMode("ace/mode/markdown"),this.parent.appendChild(this.el),sessionStorage.clear()}return r(e,[{key:"setText",value:function(t){this.editor.setValue(new String(t))}},{key:"setFile",value:function(t){var e=this;if(this.file){if(this.file==t)return;this.file.SetText(this.editor.getValue()),this.file.SetEditing(!1)}return t?void t.GetText().then(function(n){e.file=t,e.file.SetEditing(!0);var i=!0,r=!1,o=void 0;try{for(var a,l=document.querySelectorAll("[ebw-current-filename]")[Symbol.iterator]();!(i=(a=l.next()).done);i=!0){var u=a.value;u.textContent=t.path}}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}e.setText(n)}).catch(function(t){u.Error(t)}):void this.setText("-- YOU NEED TO CHOOSE A FILE YOU WANT TO EDIT --")}}]),e}(),function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}()),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),m=function(){function e(n){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t(this,e),this.parent=n,this.repo=i,i||(this.repo=n.getAttribute("ebw-repo"));var r=a(s.Template()),o=c(r,2);this.el=o[0],this.$=o[1],this.file=!1,Eventify(this.el,{save:function(t){t.preventDefault(),this.file.SetText(this.editor.getValue()),this.file.Save().then(function(){}).catch(function(t){u.Error(t)})},undo:function(t){if(t.preventDefault(),confirm("Undo the changes you've just made to "+this.file.path+"?")){var e=this.file.Original();this.file.SetText(e),this.setText(e),this.file.SetText(this.file.Original())}},delete:function(t){var e=this;t.preventDefault(),confirm("Are you sure you want to delete "+this.file.path+"?")&&this.file.Delete().then(function(t){e.file=null,e.setFile(null)}).catch(function(t){u.Error(t)})}},this),this.editor=new s(this.$.editor),this.parent.appendChild(this.el),sessionStorage.clear()}return r(e,[{key:"setText",value:function(t){this.editor.setValue(new String(t))}},{key:"setFile",value:function(t){var e=this;if(this.file){if(this.file==t)return;this.file.SetText(this.editor.getValue()),this.file.SetEditing(!1)}return t?void t.GetText().then(function(n){e.file=t,e.file.SetEditing(!0);var i=!0,r=!1,o=void 0;try{for(var a,l=document.querySelectorAll("[ebw-current-filename]")[Symbol.iterator]();!(i=(a=l.next()).done);i=!0){var u=a.value;u.textContent=t.path}}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}e.setText(n)}).catch(function(t){u.Error(t)}):void this.setText("-- YOU NEED TO CHOOSE A FILE YOU WANT TO EDIT --")}}]),e}(),c=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&l.return&&l.return()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),w=function(){function e(n,i,r){var o=this;t(this,e),this.parent=n,this.repo=i,this.editor=r,this.files=[];var l=a("RepoFileList"),s=c(l,2);this.el=s[0],this.$=s[1],Eventify(this.el,{"click-new":function(t){var e=this;t.preventDefault();var n=prompt("Enter new filename:");if(n){var i=new b(this.repo,"book/text/"+n,this,{newFile:!0});this.files.push(i),new g(this.$.fileList,i,function(t,n){e.editor.setFile(n)}),this.editor.setFile(i)}}},this),this.api=u.API(),this.api.ListFiles(i,"^book/text/.*").then(this.api.flatten(function(t){var e=!0,n=!1,r=void 0;try{for(var a,l=t[Symbol.iterator]();!(e=(a=l.next()).done);e=!0){var u=a.value,s=new b(i,u,o);o.files.push(s),new g(o.$.fileList,s,function(t,e){o.editor.setFile(e)})}}catch(t){n=!0,r=t}finally{try{!e&&l.return&&l.return()}finally{if(n)throw r}}})).catch(function(t){u.Error(t)}),this.parent.appendChild(this.el)}return r(e,[{key:"IsDirty",value:function(){var t=!0,e=!1,n=void 0;try{for(var i,r=this.files[Symbol.iterator]();!(t=(i=r.next()).done);t=!0){var o=i.value;if(o.IsDirty())return!0}}catch(t){e=!0,n=t}finally{try{!t&&r.return&&r.return()}finally{if(e)throw n}}return!1}}]),e}();window.RepoFileList=w;var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),b=function(){function e(n,i,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};t(this,e),this.repo=n,this.path=i,this.fileList=r,this.DirtySignal=new signals.Signal,this.EditingSignal=new signals.Signal,this.args=o}return r(e,[{key:"SetEditing",value:function(t){this.editing=t,this.EditingSignal.dispatch(this,t)}},{key:"IsEditing",value:function(){return this.editing}},{key:"IsDirty",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.args.newFile)return!0;t||(t=sessionStorage.getItem(this.storageKey));var e=sessionStorage.getItem(this.storageKey+"-original");return e!=t}},{key:"Save",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e||(e=sessionStorage.getItem(this.storageKey)),this.IsDirty(e)?new Promise(function(n,i){u.API().UpdateFile(t.repo,t.path,e).then(function(i){sessionStorage.setItem(t.storageKey+"-original",e),t.SetText(e),t.args.newFile=!1,n(!0)}).catch(function(t){u.Error(t),i(t)})}):Promise.resolve(!0)}},{key:"GetText",value:function(){var t=this,e=sessionStorage.getItem(this.storageKey);return e?Promise.resolve(e):this.args.newFile?Promise.resolve(""):new Promise(function(e,n){u.API().GetFileString(t.repo,t.path).then(function(n){var i=n[0];sessionStorage.setItem(t.storageKey+"-original",i),e(i)},function(t){n(t)})})}},{key:"SetText",value:function(t){sessionStorage.setItem(this.storageKey,t),this.DirtySignal.dispatch(this,this.IsDirty(t))}},{key:"Original",value:function(){return this.args.newFile?"":sessionStorage.getItem(this.storageKey+"-original")}},{key:"storageKey",get:function(){return this.repo+":"+this.path}}]),e}(),r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),k=function(){function e(n){t(this,e),this.iters=n,this.i=0}return r(e,[{key:"next",value:function(){if(this.i==this.iters.length)return{value:void 0,done:!0};var t=this.iters[this.i].next();return t.done?(this.i++,this.next()):t}},{key:Symbol.iterator,value:function(){return this}}]),e}(),E=function(){function e(n){t(this,e),this.qs=n,this.i=0}return r(e,[{key:"next",value:function(){return this.i==this.qs.length?{value:void 0,done:!0}:{value:this.qs.item(this.i++),done:!1}}},{key:Symbol.iterator,value:function(){return this}}]),e}(),S=function(t,e){var n=[];"function"==typeof t.matches?t.matches(e)&&n.push(t):"function"==typeof t.matchesSelector&&t.matchesSelector(e)&&n.push(t);var i=t.querySelectorAll(e),r=i[Symbol.iterator];return new k("function"==typeof r?[n[Symbol.iterator](),i[Symbol.iterator]()]:[n[Symbol.iterator](),new E(i)])}}();